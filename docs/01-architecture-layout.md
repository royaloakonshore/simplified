# Architecture Layout - Simplified ERP System

## 1. Overview

This ERP system utilizes a modern web architecture based on Next.js (App Router), React, TypeScript, and Supabase. It emphasizes server-side rendering (SSR) and React Server Components (RSC) for performance and reduced client-side load, with minimal, targeted use of Client Components for interactivity.

## 2. Technology Stack

- **Framework:** Next.js 14+ (App Router)
- **Language:** TypeScript 5.x (strict mode)
- **UI Library:** React 18+, Shadcn UI
- **Styling:** Tailwind CSS
- **State Management:** Zustand (minimal use for global UI state if needed), URL State (`nuqs` or similar)
- **Forms:** React Hook Form + Zod
- **Data Fetching:** Server Components, Server Actions, SWR/React Query (for client-side fetching if necessary)
- **Database:** PostgreSQL (via Supabase)
- **Authentication:** Supabase Auth
- **API Layer:** Next.js API Routes (for specific needs like webhook handling), Server Actions (primary for mutations)

## 3. Directory Structure (`/src`)

```
erp-system/
├── .env.local             # Environment variables (Supabase keys, etc.) - MANAGED BY USER
├── .eslintrc.json         # ESLint configuration
├── .gitignore
├── .prettierrc.json       # Prettier configuration
├── components.json        # Shadcn UI configuration
├── next.config.mjs        # Next.js configuration
├── package.json
├── postcss.config.js      # PostCSS configuration (for Tailwind)
├── public/
│   └── ...                # Static assets
├── README.md
├── src/
│   ├── app/               # Next.js App Router
│   │   ├── (auth)/        # Authentication routes (login, signup)
│   │   │   └── ...
│   │   ├── (main)/        # Main application layout (requires auth)
│   │   │   ├── layout.tsx # Main authenticated layout
│   │   │   ├── dashboard/ # Main dashboard page
│   │   │   │   └── page.tsx
│   │   │   ├── customers/ # Customer management feature
│   │   │   │   └── ...
│   │   │   ├── inventory/ # Inventory management feature
│   │   │   │   └── ...
│   │   │   ├── orders/    # Order management feature
│   │   │   │   └── ...
│   │   │   └── invoices/  # Invoicing feature
│   │   │       └── ...
│   │   ├── api/           # API routes (if needed beyond Server Actions)
│   │   │   └── ...
│   │   ├── favicon.ico
│   │   ├── globals.css    # Global styles (Tailwind base, Shadcn theme)
│   │   ├── layout.tsx     # Root layout
│   │   └── page.tsx       # Root (landing/public) page
│   ├── components/        # Reusable UI components
│   │   ├── auth/          # Auth-specific components (forms)
│   │   ├── core/          # Core application components (layout, nav)
│   │   ├── forms/         # General form components/wrappers
│   │   ├── icons/         # Icon components
│   │   └── ui/            # Shadcn UI components (auto-generated/customized)
│   ├── lib/               # Core logic, utilities, types, services
│   │   ├── actions/       # Server Actions (organized by feature)
│   │   │   ├── customer.actions.ts
│   │   │   ├── inventory.actions.ts
│   │   │   ├── order.actions.ts
│   │   │   └── invoice.actions.ts
│   │   ├── constants.ts   # Application-wide constants
│   │   ├── db.ts          # Database types (generated by Supabase CLI)
│   │   ├── errors.ts      # Custom error types/handling
│   │   ├── hooks/         # Custom React hooks
│   │   ├── schemas/       # Zod validation schemas (organized by feature)
│   │   ├── services/      # Client-side data fetching or complex logic (e.g., Finvoice)
│   │   │   └── finvoice.service.ts
│   │   ├── store/         # Zustand global state store (if needed)
│   │   ├── supabase/      # Supabase client setup (client, server, middleware)
│   │   │   ├── client.ts
│   │   │   ├── server.ts
│   │   │   └── middleware.ts
│   │   ├── types/         # Core TypeScript types and interfaces (branded types)
│   │   └── utils.ts       # Utility functions
│   ├── middleware.ts    # Next.js middleware (Supabase auth)
│   └── ...              # Other src files as needed
├── tailwind.config.ts     # Tailwind CSS configuration
├── tsconfig.json          # TypeScript configuration
└── tests/                 # Vitest configuration and test setup (Optional top-level)
    └── ...
```

## 4. Component Strategy

- **Server Components First:** Default to Server Components for data fetching and rendering static or server-rendered content.
- **Client Components (`'use client'`):** Use only when necessary for interactivity (event handlers, hooks like `useState`, `useEffect`, `useContext`). Keep them small and push state down as much as possible.
- **Composition:** Build complex UIs by composing smaller, reusable components.
- **Data Fetching:** Primarily in Server Components or Server Actions. Use SWR/React Query in Client Components only for specific dynamic updates (e.g., real-time polling, optimistic UI). Use Suspense for loading states.

## 5. State Management

- **URL State:** Prefer managing UI state like filters, sorting, pagination via URL search parameters (e.g., using `nuqs`).
- **Server Actions:** Handle mutations and related state updates via Server Actions and revalidation (`revalidatePath`, `revalidateTag`).
- **Zustand:** Reserve for truly global client-side UI state not easily managed by URL or component state (e.g., notification toasts, sidebar open/closed state). Avoid storing server data fetched via RSCs in Zustand.

## 6. Error Handling

- **Server Actions:** Return structured results (e.g., `{ success: true, data: ... }` or `{ success: false, error: { message: ..., code: ... } }`). Consider using a Result type pattern.
- **Client Components:** Use React Error Boundaries to catch rendering errors.
- **API Routes:** Standard HTTP error codes and JSON error responses.
- **UI:** Display user-friendly error messages (e.g., using Shadcn `Toast`). Log detailed errors to the console or a logging service.

## 7. Database Design

- See `DATABASE.md` for conceptual schema (adapt as needed).
- Use Supabase migrations for schema changes.
- Implement Row Level Security (RLS) policies to enforce data access based on user authentication and roles.

## 8. Architecture Layout & Project Structure

This document outlines the planned architecture and directory structure for the ERP system. We will leverage a standard Next.js starter template (e.g., `next-ai-starter` or similar) as the foundation, adapting it as needed.

### 8.1. Core Principles

*   **Next.js App Router:** Utilize Server Components (RSC) by default for data fetching and rendering. Client Components (`'use client'`) for interactivity only.
*   **TypeScript:** Strict mode enabled for maximum type safety.
*   **Modular Design:** Components and logic organized by feature/domain.
*   **Supabase Backend:** PostgreSQL database, Authentication, and potentially Storage.
*   **Server Actions:** Primary mechanism for data mutations.
*   **Shadcn UI & Tailwind:** For UI components and styling (monochrome theme).

### 8.2. Expected Directory Structure (Adaptable from Starter)

```
erp-system/
├── .env.local             # Environment variables (Supabase keys, etc.) - MANAGED BY USER
├── .eslintrc.json         # ESLint configuration
├── .gitignore
├── .prettierrc.json       # Prettier configuration
├── components.json        # Shadcn UI configuration
├── next.config.mjs        # Next.js configuration
├── package.json
├── postcss.config.js      # PostCSS configuration (for Tailwind)
├── public/
│   └── ...                # Static assets
├── README.md
├── src/
│   ├── app/               # Next.js App Router
│   │   ├── (auth)/        # Authentication routes (login, signup)
│   │   │   └── ...
│   │   ├── (main)/        # Main application layout (requires auth)
│   │   │   ├── layout.tsx # Main authenticated layout
│   │   │   ├── dashboard/ # Main dashboard page
│   │   │   │   └── page.tsx
│   │   │   ├── customers/ # Customer management feature
│   │   │   │   └── ...
│   │   │   ├── inventory/ # Inventory management feature
│   │   │   │   └── ...
│   │   │   ├── orders/    # Order management feature
│   │   │   │   └── ...
│   │   │   └── invoices/  # Invoicing feature
│   │   │       └── ...
│   │   ├── api/           # API routes (if needed beyond Server Actions)
│   │   │   └── ...
│   │   ├── favicon.ico
│   │   ├── globals.css    # Global styles (Tailwind base, Shadcn theme)
│   │   ├── layout.tsx     # Root layout
│   │   └── page.tsx       # Root (landing/public) page
│   ├── components/        # Reusable UI components
│   │   ├── auth/          # Auth-specific components (forms)
│   │   ├── core/          # Core application components (layout, nav)
│   │   ├── forms/         # General form components/wrappers
│   │   ├── icons/         # Icon components
│   │   └── ui/            # Shadcn UI components (auto-generated/customized)
│   ├── lib/               # Core logic, utilities, types, services
│   │   ├── actions/       # Server Actions (organized by feature)
│   │   │   ├── customer.actions.ts
│   │   │   ├── inventory.actions.ts
│   │   │   ├── order.actions.ts
│   │   │   └── invoice.actions.ts
│   │   ├── constants.ts   # Application-wide constants
│   │   ├── db.ts          # Database types (generated by Supabase CLI)
│   │   ├── errors.ts      # Custom error types/handling
│   │   ├── hooks/         # Custom React hooks
│   │   ├── schemas/       # Zod validation schemas (organized by feature)
│   │   ├── services/      # Client-side data fetching or complex logic (e.g., Finvoice)
│   │   │   └── finvoice.service.ts
│   │   ├── store/         # Zustand global state store (if needed)
│   │   ├── supabase/      # Supabase client setup (client, server, middleware)
│   │   │   ├── client.ts
│   │   │   ├── server.ts
│   │   │   └── middleware.ts
│   │   ├── types/         # Core TypeScript types and interfaces (branded types)
│   │   └── utils.ts       # Utility functions
│   ├── middleware.ts    # Next.js middleware (Supabase auth)
│   └── ...              # Other src files as needed
├── tailwind.config.ts     # Tailwind CSS configuration
├── tsconfig.json          # TypeScript configuration
└── tests/                 # Vitest configuration and test setup (Optional top-level)
    └── ...
```

### 8.3. Key Components & Interactions

*   **Root Layout (`src/app/layout.tsx`):** Provides the basic HTML structure, includes global styles and providers (e.g., Toaster).
*   **Auth Layout (`src/app/(auth)/layout.tsx`):** Layout for login/signup pages.
*   **Main Layout (`src/app/(main)/layout.tsx`):** Authenticated layout containing navigation (sidebar/header) and main content area. Fetches user session.
*   **Feature Routes (e.g., `src/app/(main)/customers/page.tsx`):** Entry points for each major feature, likely Server Components fetching initial data.
*   **UI Components (`src/components/ui/`, `src/components/core/`):** Shadcn components and custom reusable UI elements.
*   **Server Actions (`src/lib/actions/`):** Handle all data mutations, interact with Supabase, perform validation using Zod schemas.
*   **Supabase Clients (`src/lib/supabase/`):** Configured clients for Server Components, Client Components, Server Actions, API Routes, and Middleware using `@supabase/ssr`.
*   **Middleware (`src/middleware.ts`):** Handles session management and protects routes using Supabase auth helpers.
*   **Zod Schemas (`src/lib/schemas/`):** Define data shapes and validation rules, used in forms and Server Actions.
*   **Types (`src/lib/types/`, `src/lib/db.ts`):** Define application-specific types and Supabase generated types.
